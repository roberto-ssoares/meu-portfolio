<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>BA-DS-ML-Retail-Area</title>
<!-- Bootstrap -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet"/>
<!-- Jupyter Notebook CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/jupyterlab/3.6.3/themes/JupyterLab-light-theme.css" rel="stylesheet"/>
<!-- Google Fonts (Correção de espaço por "+") -->
<link href="https://fonts.googleapis.com/css2?family=Gloria+Hallelujah&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Caveat&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Architects+Daughter&amp;display=swap" rel="stylesheet"/>
<!-- Highlight.js for code syntax -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
<style>
        body {
            font-family: 'Source Sans Pro', sans-serif;
            background-color: #f8f9fa;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: auto;
            background: #f9f9f9;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .code_cell {
            background-color: #e8f5e9 !important;
            font-family: 'Anonymous Pro', monospace;
            font-size: 15px;
            border-left: 5px solid #4caf50;
            padding: 5px;
            margin: 15px 0;
            overflow-x: auto;
            border-radius: 5px;
        }
        .output {
            background-color: #f1f7fa;
            border-left: 5px solid #2196f3;
            padding: 5px;
            margin: 15px 0;
            font-family: 'Ubuntu', monospace;
            font-size: 15px;
            white-space: pre-wrap;
            overflow-x: auto;
            border-radius: 5px;
        }
        .output img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: auto;
            background-color: transparent !important;
        }
        h1, h2, h3 {
            color: #333;
        }
        .title-header {
            font-family: 'Caveat', cursive;
            font-weight: bold;
            font-size: 25px;
            color: #84888c;
            text-transform: uppercase;
            text-align: right;
            margin-bottom: 10px;
        }
        .markdown {
            font-family: 'Architects Daughter', cursive;
            font-size: 15px;
            background-color: #f3f2ee;
            padding: 5px;
            border-left: 4px solid #ff9800;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .footer {
            font-family: 'Gloria Hallelujah', cursive;
            font-size: 18px;            
            text-align: right;
            color: #84888c;
            margin-top: 10px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
        }
        pre, code {
            background-color: transparent !important;
            border: none;
            font-size: 14px;
        }
    </style>
</head>
<body>
<div class="container">
<h1 class="title-header">BA-DS-ML-Retail-Area</h1>
<div class="cell">
<div aria-label="Markdown Cell" class="markdown" role="region">
<div style="background-color:#F3F2EE">
<p><br/><br/></p>
<p style="text-align: center;">
<font color="#0A1781" size="6">
<strong>
        Business Analytics &amp; Machine Learning
    </strong>
</font>
</p>
<p style="text-align: center;">
<font color="#C58A1E" size="6.5">
<strong>Business Analysis, Data Science and<br/>Machine Learning in the Retail Sector
</strong></font>
</p>
<p><br/><br/></p>
</div>
</div>
</div>
<div class="cell">
<div aria-label="Markdown Cell" class="markdown" role="region">
<div style="background-color:#F4F4F4">
<p style="text-align: right;">
<font color="#444444" size="4">
    Roberto Soares - LfLngLrnng
  </font>
</p>
<p style="text-align: right;"><font color="#444444" size="2">
<a href="https://www.linkedin.com/in/roberto-dos-santos-soares/">in/roberto-dos-santos-soares</a>
<p style="text-align: right;"><font color="#444444" size="2">
<a href="https://github.com/roberto-ssoares/roberto-ssoares.github.io">Portifólio: roberto-ssoares</a>
<p style="text-align: right;">
<font color="#444444" size="3">
    [+] Faturamento,<br \=""/> [-] Custo,<br \=""/> [+] Qualidade de vida  
  </font>
</p>
</font></p></font></p></div>
</div>
</div>
<div class="cell">
<div aria-label="Markdown Cell" class="markdown" role="region">
<div style="background-color:#F3F2EE">
<p style="text-align: left;">
<font color="#0A1781" size="5">
<strong>
        Projeto - IA (LLMs) para Previsão de Demanda e Otimização do Estoque de Produtos Sazonais
    </strong>
</font>
</p>
</div>
</div>
</div>
<div class="cell">
<div aria-label="Markdown Cell" class="markdown" role="region">
<div style="background-color:#F3F2EE">
<p><font color="#CC403E" size="4"><strong>Produtos sazonais</strong></font></p>
<font color="#66666" size="3">
<ul>
<li>Bens ou serviços cuja demanda varia significativamente ao longo do ano, dependendo de fatores como estações do ano, feriados, eventos específicos ou tendências periódicas.</li>
<li>Esses produtos geralmente estão associados a épocas ou períodos específicos e têm maior procura em determinados momentos, enquanto sua demanda diminui ou se torna inexistente fora desses períodos.</li>
</ul>
<p><strong>Exemplos de produtos sazonais:</strong></p>
<ul>
<li><strong>Roupas de inverno</strong>: Casacos e luvas têm maior demanda em climas frios ou durante o inverno.</li>
<li><strong>Artigos de verão</strong>: Roupas de banho, ventiladores e protetores solares são mais procurados no verão.</li>
<li><strong>Produtos alimentícios temáticos</strong>: Panetones no Natal, ovos de chocolate na Páscoa ou comidas típicas de festas juninas.</li>
<li><strong>Itens relacionados a eventos específicos</strong>: Decorações para Halloween ou produtos ligados a eventos esportivos, como copos temáticos para a Copa do Mundo.</li>
</ul>
<p><strong>Características principais:</strong></p>
<ol>
<li><strong>Demanda periódica</strong>: A procura ocorre em ciclos ou períodos específicos.</li>
<li><strong>Planejamento necessário</strong>: Empresas precisam se antecipar, ajustando estoques, marketing e produção conforme a sazonalidade.</li>
<li><strong>Impacto no preço</strong>: Em períodos de alta demanda, os preços podem subir, enquanto fora de temporada, podem ocorrer descontos ou promoções.</li>
</ol>
<p>Gerenciar produtos sazonais de forma eficiente exige uma boa compreensão dos padrões de consumo e estratégias para evitar excesso de estoque ou falta de produtos durante os períodos de maior procura.</p>
</font></div>
</div>
<div class="cell">
<div aria-label="Markdown Cell" class="markdown" role="region">
<div style="background-color:#F3F2EE">
<p><font color="#CC403E" size="5"><strong>CRISP-DM [Business Understanding]</strong></font></p>
<font color="#66666" size="3">
<p><strong>1. Objetivo Principal</strong></p>
<ul>
<li>Desenvolver uma solução baseada em Inteligência Artificial (IA) que integre Modelos de Linguagem de Grande Escala (LLMs) e análise de dados estruturados para prever demandas e otimizar estoques de produtos sazonais, promovendo eficiência operacional e reduzindo desperdícios.</li>
</ul>
<p><strong>2. Questões de Negócio</strong></p>
<ol>
<li><strong>Previsão de demanda</strong>:<ul>
<li>Quais produtos sazonais terão maior ou menor demanda nos próximos períodos?</li>
<li>Como podemos prever as variações sazonais com maior precisão, minimizando falhas na disponibilidade de produtos?</li>
</ul>
</li>
<li><strong>Otimização de Estoques</strong>:<ul>
<li>Qual é a quantidade ideal de estoque para cada produto em períodos de alta e baixa sazonalidade?</li>
<li>Como balancear o custo de manter estoque (overstock) com o risco de perda de vendas por falta de produtos (stockout)?</li>
</ul>
</li>
<li><strong>Eficiência Operacional</strong>:<ul>
<li>Quais insights podem ser extraídos para ajudar na logística, reposição e alocação de produtos entre unidades ou regiões?</li>
</ul>
</li>
</ol>
<p><strong>3. Objetivos de Negócio</strong></p>
<ol>
<li><strong>Reduzir custos</strong>: Minimizar desperdícios de estoque e evitar custos excessivos de armazenamento.</li>
<li><strong>Aumentar a receita</strong>: Melhorar a disponibilidade de produtos em períodos de alta demanda para maximizar vendas.</li>
<li><strong>Melhorar a satisfação do cliente</strong>: Garantir que produtos estejam disponíveis no momento certo e na quantidade certa.</li>
<li><strong>Apoiar decisões estratégicas</strong>: Fornecer insights baseados em dados e IA para ajudar equipes de vendas, marketing e logística a planejar campanhas e operações.</li>
</ol>
<p><strong>4. Relevância para o Negócio</strong></p>
<ul>
<li>Produtos sazonais têm impacto significativo nos lucros de empresas que lidam com varejo, moda, alimentos e bens de consumo.</li>
<li>Estimar a demanda com precisão pode evitar perdas financeiras significativas por excesso ou falta de estoque.</li>
<li>Uma abordagem baseada em dados estruturados e IA pode melhorar a competitividade da empresa em mercados dinâmicos.</li>
</ul>
<p><strong>5. Limitações do Projeto</strong></p>
<ul>
<li><strong>Dados fictícios</strong>: Apesar de permitir um controle maior, pode não refletir perfeitamente as nuances e complexidades de dados reais.</li>
<li><strong>Dependência de LLMs</strong>: Modelos de linguagem podem exigir ajustes para trabalhar com informações específicas do domínio.</li>
</ul>
<p><strong>6. Indicadores de Sucesso (KPIs)</strong></p>
<ol>
<li><strong>Precisão da previsão de demanda</strong>: Percentual de acertos em relação à demanda real de produtos.</li>
<li><strong>Redução de custos de estoque</strong>: Comparação dos custos antes e após a implementação do projeto.</li>
<li><strong>Redução do índice de stockouts</strong>: Percentual de produtos em falta durante períodos de alta demanda.</li>
<li><strong>Aumento da eficiência operacional</strong>: Redução de desperdícios e melhor balanceamento de estoques.</li>
<li><strong>Melhoria na satisfação do cliente</strong>: Medido por indicadores como Net Promoter Score (NPS) ou taxas de reclamação.</li>
</ol>
<p><strong>7. Contexto de Mercado e Insights</strong></p>
<ol>
<li><strong>Tendências tecnológicas</strong>:<ul>
<li>O uso de LLMs em previsão de demanda é uma inovação crescente no mercado, capaz de considerar variáveis complexas como notícias, clima e comportamento do consumidor.</li>
</ul>
</li>
<li><strong>Cenário competitivo</strong>:<ul>
<li>Empresas que utilizam IA para gerenciar estoques tendem a ter vantagem competitiva devido à maior eficiência e flexibilidade operacional.</li>
</ul>
</li>
<li><strong>Ciclo de vida do produto</strong>:<ul>
<li>É essencial considerar o estágio de cada produto (lançamento, crescimento, maturidade ou declínio) no modelo de previsão e otimização.</li>
</ul>
</li>
</ol>
<p><strong>8. Soluções Complementares</strong></p>
<ul>
<li><strong>Integração de Dados</strong>:<ul>
<li>Utilizar SQL para consolidar informações de diferentes fontes (transações, histórico de vendas, clima, eventos) em uma base única para análise.</li>
</ul>
</li>
<li><strong>Modelagem Sazonal</strong>:<ul>
<li>Implementar técnicas específicas, como decomposição de séries temporais e algoritmos de aprendizado supervisionado, para identificar padrões sazonais.</li>
</ul>
</li>
<li><strong>Simulações Operacionais</strong>:<ul>
<li>Realizar simulações baseadas em cenários hipotéticos para validar a robustez do modelo e preparar estratégias para variações inesperadas.</li>
</ul>
</li>
</ul>
</font></div>
</div>
<div class="cell">
<div aria-label="Markdown Cell" class="markdown" role="region">
<div style="background-color:#F3F2EE">
<p><font color="#CC403E" size="4"><strong>Estratégia e Abordagem</strong></font></p>
<font color="#66666" size="3">
<p><strong>Projeto típico de uma empresa de varejo: Previsão de demanda e otimização de estoque</strong></p>
<p><strong>Descrição do Problema</strong></p>
<ul>
<li>A empresa enfrenta dificuldades em gerenciar o estoque de produtos sazonais, cuja demanda é irregular ao longo do ano.</li>
<li>Essa imprevisibilidade pode levar tanto a faltas no estoque quanto a excesso de produtos armazenados, resultando em perdas financeiras.</li>
</ul>
<p><strong>Estratégia Inicial - Abordagem Tradicional</strong><br>
O problema pode ser dividido em dois subprojetos, com base no framework CRISP-DM:</br></p>
<ol>
<li><p><strong>Previsão de Demanda:</strong></p>
<ul>
<li><strong>Passos:</strong><ul>
<li>Coletar e preparar dados históricos de vendas, estoques e sazonalidades.</li>
<li>Treinar um modelo de machine learning adequado para prever a demanda futura com base nos padrões históricos.</li>
</ul>
</li>
<li><strong>Exemplo de Algoritmos:</strong><ul>
<li>Modelos de regressão (Linear, Ridge, etc.).</li>
<li>Modelos baseados em séries temporais (ARIMA, Prophet).</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Otimização de Estoque:</strong></p>
<ul>
<li><strong>Passos:</strong><ul>
<li>Utilizar os resultados da previsão de demanda como insumos para algoritmos de otimização.</li>
<li>Implementar estratégias que minimizem custos relacionados ao excesso ou falta de estoque.</li>
</ul>
</li>
<li><strong>Exemplo de Algoritmos:</strong><ul>
<li>Algoritmos heurísticos (como otimização por enxame de partículas ou algoritmos genéticos).</li>
<li>Programação linear ou não linear para calcular o nível ótimo de estoque.</li>
</ul>
</li>
</ul>
</li>
</ol>
<p><strong>Limitações da Abordagem Tradicional</strong></p>
<ul>
<li><strong>Tempo elevado:</strong> A implementação e ajuste desses modelos demandam recursos e tempo.</li>
<li><strong>Falta de flexibilidade:</strong> Estratégias tradicionais muitas vezes não conseguem capturar nuances complexas, como mudanças abruptas na demanda.</li>
</ul>
<p><strong>Abordagem Avançada - Utilizando LLMs (Large Language Models)</strong><br>
Com os avanços em inteligência artificial, modelos de linguagem como GPT podem ser usados para substituir ou complementar abordagens tradicionais.</br></p>
<ol>
<li><p><strong>Entrada de Dados no LLM:</strong></p>
<ul>
<li>Coletar dados históricos de vendas, estoque, produtos e sazonalidades diretamente do banco de dados da empresa.</li>
<li>Estruturar esses dados no formato de texto ou tabelas para alimentar o modelo LLM.</li>
</ul>
</li>
<li><p><strong>Processamento pelo LLM:</strong></p>
<ul>
<li>Os LLMs são capazes de compreender texto natural, identificar padrões e gerar previsões coerentes com alta eficiência.</li>
<li>A saída gerada pode incluir:<ul>
<li>Previsão de demanda para períodos futuros.</li>
<li>Sugestões de otimização do estoque com base em análises contextualizadas.</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Resultados Esperados:</strong></p>
<ul>
<li><strong>Eficiência operacional:</strong> Previsões mais precisas e em menos tempo.</li>
<li><strong>Insights acionáveis:</strong> O modelo não apenas prevê demandas, mas também pode sugerir estratégias detalhadas para armazenamento e reposição.</li>
<li><strong>Flexibilidade:</strong> Capacidade de adaptar-se rapidamente a mudanças nos padrões de consumo.</li>
</ul>
</li>
</ol>
<p><strong>Vantagens da Nova Abordagem</strong></p>
<ul>
<li><strong>Velocidade:</strong> Processamento significativamente mais rápido em relação aos métodos tradicionais.</li>
<li><strong>Precisão:</strong> LLMs conseguem incorporar contextos complexos e gerar previsões mais detalhadas.</li>
<li><strong>Simplicidade:</strong> Reduz a necessidade de configurações manuais detalhadas, como ajuste de hiperparâmetros.</li>
</ul>
<p><strong>Considerações Finais</strong></p>
<ul>
<li><strong>Substituir a abordagem tradicional pela avançada, baseada em LLMs, não significa descartar totalmente métodos clássicos, mas sim complementá-los.</strong></li>
<li><strong>O uso integrado de machine learning estruturado e LLMs pode maximizar os resultados, oferecendo uma solução mais robusta, rápida e alinhada<br/>com as necessidades de empresas varejistas que lidam com sazonalidades complexas.</strong></li>
</ul>
</font></div>
</div>
<div class="cell">
<div aria-label="Markdown Cell" class="markdown" role="region">
<div style="background-color:#F3F2EE">
<p><font color="#CC403E" size="5"><strong>CRISP-DM [Data Understanding]</strong></font></p>
<font color="#66666" size="3">
</font></div>
</div>
<div class="cell">
<div aria-label="Markdown Cell" class="markdown" role="region">
<div style="background-color:#F3F2EE">
<p><font color="#CC403E" size="4"><strong>Script 02-CriaTabelas.py</strong></font></p>
<font color="#66666" size="2">
<p>Python - Pipeline de Criação do Banco de Dados</p>
<p><strong>Descrição do objetivo deste script:</strong></p>
<ul>
<li>Automatizar a execução de um script SQL armazenado em um arquivo externo para<br/>criar e configurar tabelas dentro de um banco de dados PostgreSQL.</li>
</ul>
<p><strong>Ações realizadas no script:</strong></p>
<ol>
<li>Carrega variáveis de ambiente a partir de um arquivo <strong>.env</strong> (melhor segurança).</li>
<li>Estabelece conexão com o PostgreSQL utilizando credenciais seguras.</li>
<li>Lê e executa múltiplos comandos SQL de um arquivo <strong>.sql</strong>, garantindo que cada comando seja processado corretamente.</li>
<li>Confirma ou reverte as mudanças conforme necessário.</li>
<li>Exibe mensagens de status para facilitar o acompanhamento da execução.</li>
<li>Fecha a conexão com o banco de dados corretamente.</li>
</ol>
<p><strong>Justificativa técnica:</strong></p>
<ul>
<li>Utilizar <strong>dotenv</strong> evita expor credenciais no código, seguindo boas práticas de segurança.</li>
<li>Separar comandos SQL por <strong>;</strong> permite executar múltiplas instruções corretamente.</li>
<li>Mensagens de status ajudam no monitoramento e depuração do processo.</li>
<li>Uso de <strong>try-except-finally</strong> protege contra falhas, garantindo rollback em caso de erro.</li>
</ul>
<p><strong>Resultados esperados:</strong></p>
<ul>
<li>O banco de dados será atualizado com novas tabelas e estruturas conforme definidas no script SQL.</li>
<li>Caso ocorra um erro, a execução será interrompida com um rollback, preservando a integridade do banco.</li>
<li>Logs no console indicarão o andamento da execução para facilitar a depuração.</li>
</ul>
</font></div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python">#!pip install -q psycopg2
#!conda install anaconda::psycopg2
#!pip install -q dotenv</code></pre>
</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python"># Python - Pipeline de Criação do Banco de Dados
import psycopg2
import os
from dotenv import load_dotenv</code></pre>
</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python"># Versões dos pacotes usados neste jupyter notebook
%reload_ext watermark
%watermark -a "Roberto-SSoares-LfLngLrnng"</code></pre>
</div>
<div aria-label="Code Output" class="output" role="region">Author: Roberto-SSoares-LfLngLrnng

</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python"># Carregar variáveis de ambiente do arquivo .env
load_dotenv('config-postgresql.env',override=True)</code></pre>
</div>
<div class="output">True</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python">def fn_executa_script_sql(filename):
    """Executa um script SQL no PostgreSQL a partir de um arquivo."""
    
    print("\nIniciando execução do script SQL...")

    # Conectar ao banco de dados PostgreSQL usando variáveis de ambiente
    # Use psycop2.connect() em conexões de uso rápido, como criar tabelas.
    # Para usos maiores como importar dados para tabela, o melhor é sqlalchemy.
    try:
        conn = psycopg2.connect(
            dbname=os.getenv("DB_NAME"),
            user=os.getenv("DB_USER"),
            password=os.getenv("DB_PASSWORD"),
            host=os.getenv("DB_HOST"),
            port=os.getenv("DB_PORT")
        )
        print("Conexão com o banco de dados estabelecida com sucesso.")
    except Exception as e:
        print(f"Erro ao conectar ao banco de dados: {e}")
        return

    cur = conn.cursor()

    # Ler e executar o conteúdo do arquivo SQL
    try:
        with open(filename, 'r', encoding='utf-8') as file:
            sql_script = file.read()

        # Separar os comandos SQL por `;` e executar um por um
        sql_commands = sql_script.strip().split(';')

        for command in sql_commands:
            if command.strip():  # Ignorar linhas vazias
                cur.execute(command)
        
        conn.commit()
        print("\n✅ Script executado com sucesso!\n")
    
    except Exception as e:
        conn.rollback()
        print(f"❌ Erro ao executar o script: {e}")

    finally:
        cur.close()
        conn.close()
        print("Conexão com o banco de dados fechada.")
</code></pre>
</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python"># Executar o script SQL Atenção o Docker deve estar ativo juntamente com o container PostgreSQL
fn_executa_script_sql('ProjetoVarejo-01-Tabelas.sql')</code></pre>
</div>
<div aria-label="Code Output" class="output" role="region">
Iniciando execução do script SQL...
Conexão com o banco de dados estabelecida com sucesso.

✅ Script executado com sucesso!

Conexão com o banco de dados fechada.
</div>
</div>
<div class="cell">
<div aria-label="Markdown Cell" class="markdown" role="region">
<div style="background-color:#F3F2EE">
<p><font color="#CC403E" size="4"><strong>Script 03-CarregaDados.py</strong></font></p>
<font color="#66666" size="2">
<p>Python e SQL - Pipeline de Carga de Dados</p>
<p><strong>Descrição do objetivo deste script:</strong></p>
<ul>
<li>O objetivo desta célula é carregar dados de múltiplos arquivos CSV para um banco de dados PostgreSQL, garantindo que os dados sejam inseridos nas tabelas corretas dentro do schema especificado.</li>
<li>Estabelecer uma conexão com o banco de dados PostgreSQL, usando credenciais armazenadas em um arquivo .env para não expor as informações sensíveis diretamente no código.</li>
<li>A célula também estabelece a conexão com o banco de dados utilizando SQLAlchemy, que facilita a integração do pandas com o PostgreSQL.</li>
</ul>
<p><strong>Ações realizadas no script:</strong></p>
<ol>
<li>Carregar as variáveis de ambiente usando a função load_dotenv() da biblioteca dotenv.</li>
<li>Construir a string de conexão com o banco de dados utilizando as credenciais carregadas das variáveis de ambiente.</li>
<li>Importação das bibliotecas necessárias para o trabalho com banco de dados (psycopg2, sqlalchemy) e manipulação de dados (pandas).</li>
<li>Estabelecimento de uma conexão com o banco de dados PostgreSQL usando o SQLAlchemy e a string de conexão fornecida.</li>
<li>Definição da função <strong>fn_carrega_dados</strong>, que recebe arquivos CSV e carrega os dados em uma tabela específica no banco de dados.</li>
<li>Uso do <strong>pandas.read_csv()</strong> para ler os dados do arquivo CSV.</li>
<li>A função <strong>to_sql</strong> do pandas é utilizada para enviar o dataframe para o banco de dados.<ul>
<li>O parâmetro <strong>'if_exists='append'</strong> assegura que os dados sejam adicionados à tabela existente sem sobrescrever os dados.</li>
</ul>
</li>
<li>A execução da função de carregamento de dados para múltiplos arquivos CSV e suas respectivas tabelas no banco de dados.</li>
</ol>
<p><strong>Justificativa técnica:</strong></p>
<ul>
<li>O uso de <strong>SQLAlchemy</strong> e <strong>pandas</strong> simplifica a interação entre Python e PostgreSQL, permitindo carregamento eficiente dos dados.</li>
<li>A função <strong>to_sql</strong> do pandas é ideal para carregar grandes volumes de dados de CSV para o banco de dados de forma automatizada.</li>
<li>A string de conexão do SQLAlchemy facilita a configuração da conexão com o banco de dados e a execução de operações.</li>
<li>A estratégia <strong>if_exists='append'</strong> garante que os dados sejam adicionados às tabelas sem afetar as tabelas já existentes no banco de dados.</li>
<li>O bloco <strong>try-except</strong> é usado para garantir que qualquer erro durante o processo de carga seja tratado de forma adequada e informada.</li>
</ul>
<p><strong>Resultados esperados:</strong></p>
<ul>
<li>Os dados de cada arquivo CSV serão carregados nas respectivas tabelas dentro do banco de dados PostgreSQL, com sucesso.</li>
<li>Caso ocorra algum erro durante a carga de dados (por exemplo, problemas de formato ou conexão), o erro será capturado e exibido.</li>
<li>O usuário será informado sobre o sucesso ou falha no processo de carga de dados, com feedback detalhado sobre cada arquivo.</li>
<li>Após o término da execução, o processo de análise de dados com IA será iniciado, como parte do pipeline de processamento.</li>
</ul>
</font></div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python"># Projeto Varejo - IA Para Previsão de Demanda e Otimização do Estoque de Produtos Sazonais
# Imports
import psycopg2
import pandas as pd
import os
from dotenv import load_dotenv
from sqlalchemy import create_engine</code></pre>
</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python"># Versões dos pacotes usados neste jupyter notebook
%reload_ext watermark
%watermark -a "Roberto-SSoares-LfLngLrnng"</code></pre>
</div>
<div aria-label="Code Output" class="output" role="region">Author: Roberto-SSoares-LfLngLrnng

</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python"># Carregar variáveis de ambiente do arquivo .env
load_dotenv('config-postgresql.env',override=True)</code></pre>
</div>
<div class="output">True</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python"># Cria o motor de conexão (ATENÇÃO COM A STRING DE CONEXÃO ABAIXO!!!!!!) e conexão com as credenciais carregadas do arquivo .env
engine = create_engine(f'postgresql+psycopg2://{os.getenv("DB_USER")}:{os.getenv("DB_PASSWORD")}@{os.getenv("DB_HOST")}:{os.getenv("DB_PORT")}/{os.getenv("DB_NAME")}')

print("\nIniciando o Processo de Carga dos Dados!\n")</code></pre>
</div>
<div aria-label="Code Output" class="output" role="region">
Iniciando o Processo de Carga dos Dados!

</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python"># Função para carregar dados dos arquivos CSV para o PostgreSQL no schema especificado
def fn_carrega_dados(csv_file, table_name, schema):
    # Bloco try/except para lidar com exceções durante o processo
    try:
        # Lê o arquivo CSV utilizando o pandas
        df = pd.read_csv(csv_file)

        # Carrega os dados do dataframe para a tabela do banco de dados
        df.to_sql(table_name, engine, schema=schema, if_exists='append', index=False)
        print(f"Dados do arquivo {csv_file} foram inseridos na tabela {schema}.{table_name}.")
    
    except Exception as e:
        print(f"Erro ao inserir dados do arquivo {csv_file} na tabela {schema}.{table_name}: {e}")</code></pre>
</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python"># Carregamento dos dados no schema 'projetoVarejo'
schema = 'projetovarejo'

fn_carrega_dados('tb_fornecedores.csv', 'fornecedores', schema)
fn_carrega_dados('tb_categorias.csv', 'categorias', schema)
fn_carrega_dados('tb_produtos.csv', 'produtos', schema)
fn_carrega_dados('tb_clientes.csv', 'clientes', schema)
fn_carrega_dados('tb_vendas.csv', 'vendas', schema)
fn_carrega_dados('tb_estoque.csv', 'estoque', schema)
fn_carrega_dados('tb_sazonalidade.csv', 'sazonalidade', schema)
fn_carrega_dados('tb_forecast.csv', 'forecast', schema)
fn_carrega_dados('tb_reabastecimento.csv', 'reabastecimento', schema)
fn_carrega_dados('tb_pedidos.csv', 'pedidos', schema)

print("\nCarga Executada com Sucesso! Use o pgAdmin Para Checar os Dados Se Desejar!\n")
print("\nIniciando o Processo de Análise dos Dados com IA. Seja Paciente e Aguarde o Excelente Resultado Que Será Entregue a Você!\n")</code></pre>
</div>
<div aria-label="Code Output" class="output" role="region">Dados do arquivo tb_fornecedores.csv foram inseridos na tabela projetovarejo.fornecedores.
Dados do arquivo tb_categorias.csv foram inseridos na tabela projetovarejo.categorias.
Dados do arquivo tb_produtos.csv foram inseridos na tabela projetovarejo.produtos.
Dados do arquivo tb_clientes.csv foram inseridos na tabela projetovarejo.clientes.
Dados do arquivo tb_vendas.csv foram inseridos na tabela projetovarejo.vendas.
Dados do arquivo tb_estoque.csv foram inseridos na tabela projetovarejo.estoque.
Dados do arquivo tb_sazonalidade.csv foram inseridos na tabela projetovarejo.sazonalidade.
Dados do arquivo tb_forecast.csv foram inseridos na tabela projetovarejo.forecast.
Dados do arquivo tb_reabastecimento.csv foram inseridos na tabela projetovarejo.reabastecimento.
Dados do arquivo tb_pedidos.csv foram inseridos na tabela projetovarejo.pedidos.

Carga Executada com Sucesso! Use o pgAdmin Para Checar os Dados Se Desejar!


Iniciando o Processo de Análise dos Dados com IA. Seja Paciente e Aguarde o Excelente Resultado Que Será Entregue a Você!

</div>
</div>
<div class="cell">
<div aria-label="Markdown Cell" class="markdown" role="region">
<div style="background-color:#F3F2EE">
<p><font color="#CC403E" size="4"><strong>Script 04-LLM.py</strong></font></p>
<font color="#66666" size="2">
<p>Python - Pipeline de Extração de Insights com LLM</p>
<p><strong>Descrição do objetivo da célula:</strong></p>
<ul>
<li>Esta célula tem como objetivo extrair insights sobre demanda e estoque de produtos sazonais, utilizando um modelo de linguagem natural (LLM) para gerar<br/>análises automatizadas com base nos dados de vendas, estoque e previsões armazenados em um banco PostgreSQL.</li>
</ul>
<p><strong>Ações realizadas na célula:</strong></p>
<ol>
<li>Importa as bibliotecas necessárias (csv, psycopg2, langchain).</li>
<li>Instancia o modelo de linguagem (Llama3 via Ollama) e configura um parser para processar sua saída.</li>
<li>Conecta-se ao banco de dados PostgreSQL e executa uma query SQL para coletar dados de produtos, vendas, estoque, sazonalidade e previsões de demanda.</li>
<li>Formata os dados obtidos e cria um prompt para o LLM analisar cada produto.</li>
<li>O LLM gera insights baseados nas informações coletadas, que são armazenados em uma lista.</li>
<li>Salva os insights gerados em um arquivo CSV para análise posterior.</li>
<li>Exibe os insights gerados no console.</li>
</ol>
<p><strong>Justificativa técnica:</strong></p>
<ul>
<li>O uso de um banco de dados PostgreSQL permite armazenar e consultar grandes volumes de dados estruturados de forma eficiente.</li>
<li>A consulta SQL é projetada para combinar diferentes fontes de dados (vendas, estoque, previsão de demanda, etc.), garantindo uma visão holística da situação de cada produto.</li>
<li>A utilização de um LLM como o Llama3 automatiza a análise dos dados, permitindo extrair padrões e recomendações sem necessidade de scripts manuais complexos.</li>
<li>A exportação para CSV permite compartilhar e visualizar os insights facilmente, possibilitando integração com outras ferramentas analíticas.</li>
</ul>
<p><strong>Resultados esperados:</strong></p>
<ul>
<li>Geração automática de insights sobre a demanda e o estoque dos produtos sazonais.</li>
<li>Identificação de possíveis problemas, como excesso ou falta de estoque, permitindo tomada de decisão baseada em dados.</li>
<li>Exportação dos insights para um arquivo CSV, facilitando sua análise e compartilhamento.</li>
<li>Exibição dos insights diretamente no console para uma rápida visualização e validação dos resultados.</li>
</ul>
</font></div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python"># Projeto Varejo - IA Para Previsão de Demanda e Otimização do Estoque de Produtos Sazonais
# Python - Pipeline de Extração de Insights com LLM

# Imports
import csv
import psycopg2
import os
from dotenv import load_dotenv
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
#from langchain_community.llms.ollama import Ollama  # Antigo
from langchain_ollama import OllamaLLM</code></pre>
</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python"># Versões dos pacotes usados neste jupyter notebook
%reload_ext watermark
%watermark -a "Roberto-SSoares-LfLngLrnng"</code></pre>
</div>
<div aria-label="Code Output" class="output" role="region">Author: Roberto-SSoares-LfLngLrnng

</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python"># Carregar variáveis de ambiente do arquivo .env
load_dotenv('config-postgresql.env',override=True)</code></pre>
</div>
<div class="output">True</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python"># Instanciação do LLM Llama3 através do Ollama
#llm = Ollama(model = "llama3") # Antigo
llm = OllamaLLM(model="llama3")</code></pre>
</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python"># Criação do parser para a saída do modelo de linguagem
output_parser = StrOutputParser()</code></pre>
</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python"># Define a consulta SQL para obter dados dos clientes, compras e produtos
# Lista de categorias
categoria = ['Eletrônicos', 'Roupas']

# Criar placeholders dinâmicos para a lista
placeholders = ', '.join(['%s'] * len(categoria))

# Query com placeholders
sql_query = f"""
            SELECT
                p.id_produto AS id_produto,
                p.nome_produto AS nome_produto,
                c.nome_categoria AS nome_categoria,
                f.nome_fornecedor AS nome_fornecedor,
                COALESCE(SUM(v.quantidade_vendida), 0) AS total_vendido,
                COALESCE(e.quantidade_em_estoque, 0) AS quantidade_em_estoque,
                COALESCE(s.nome_temporada, 'Nenhuma') AS temporada,
                COALESCE(fore.quantidade_forecast, 0) AS quantidade_forecast,
                COALESCE(re.quantidade, 0) AS quantidade_reabastecida
            FROM
                projetoVarejo.produtos p
            LEFT JOIN
                projetoVarejo.categorias c ON p.id_categoria = c.id_categoria
            LEFT JOIN
                projetoVarejo.fornecedores f ON p.id_fornecedor = f.id_fornecedor
            LEFT JOIN
                projetoVarejo.vendas v ON p.id_produto = v.id_produto
            LEFT JOIN
                projetoVarejo.estoque e ON p.id_produto = e.id_produto
            LEFT JOIN
                projetoVarejo.sazonalidade s ON p.id_produto = s.id_produto
            LEFT JOIN
                projetoVarejo.forecast fore ON p.id_produto = fore.id_produto
            LEFT JOIN
                projetoVarejo.reabastecimento re ON p.id_produto = re.id_produto
            WHERE
                c.nome_categoria IN ({placeholders})
            GROUP BY
                p.id_produto, p.nome_produto, c.nome_categoria, f.nome_fornecedor,
                e.quantidade_em_estoque, e.data_ultimo_reabastecimento,
                s.nome_temporada, s.data_inicio, s.data_fim,
                fore.quantidade_forecast, re.quantidade, re.data_reabastecimento
            ORDER BY
                p.id_produto;
        """</code></pre>
</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python">import psycopg2

# Lista de categorias
categoria = ['Eletrônicos', 'Roupas']

# Conectar ao banco
# Conecta ao banco de dados PostgreSQL com as credenciais fornecidas
conn = psycopg2.connect(
        dbname=os.getenv("DB_NAME"),
        user=os.getenv("DB_USER"),
        password=os.getenv("DB_PASSWORD"),
        host=os.getenv("DB_HOST"),
        port=os.getenv("DB_PORT")
    )

cur = conn.cursor()

# Criar placeholders dinâmicos para a lista
placeholders = ', '.join(['%s'] * len(categoria))

# Query com placeholders
query = sql_query

# Executar a query passando os valores da lista
cur.execute(query, categoria)

# Obter os resultados
resultados = cur.fetchall()

# Fechar conexão
cur.close()
conn.close()

# Exibir resultados
print(resultados)
</code></pre>
</div>
<div aria-label="Code Output" class="output" role="region">[(1, 'Smartphone', 'Eletrônicos', 'Fornecedor A', 3, 50, 'Dia das Mães', 50, 50), (2, 'Laptop', 'Eletrônicos', 'Fornecedor A', 3, 30, 'Nenhuma', 30, 30), (3, 'TV 55"', 'Eletrônicos', 'Fornecedor B', 3, 20, 'Nenhuma', 20, 20), (4, 'Caixa de Som Bluetooth', 'Eletrônicos', 'Fornecedor C', 5, 100, 'Nenhuma', 100, 100), (5, 'Tablet', 'Eletrônicos', 'Fornecedor D', 3, 40, 'Nenhuma', 40, 40), (11, 'Camisa Polo', 'Roupas', 'Fornecedor A', 5, 70, 'Nenhuma', 70, 0), (12, 'Calça Jeans', 'Roupas', 'Fornecedor B', 2, 60, 'Nenhuma', 60, 0), (13, 'Tênis Esportivo', 'Roupas', 'Fornecedor C', 2, 90, 'Nenhuma', 90, 0), (14, 'Jaqueta de Couro', 'Roupas', 'Fornecedor D', 3, 80, 'Nenhuma', 80, 0), (15, 'Meias 3 pares', 'Roupas', 'Fornecedor E', 9, 130, 'Dia dos Pais', 130, 0)]
</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python"># Função para gerar texto baseado nos dados do PostgreSQL
def fn_gera_insights():

    # Conecta ao banco de dados PostgreSQL com as credenciais fornecidas
    conn = psycopg2.connect(
        dbname=os.getenv("DB_NAME"),
        user=os.getenv("DB_USER"),
        password=os.getenv("DB_PASSWORD"),
        host=os.getenv("DB_HOST"),
        port=os.getenv("DB_PORT")
    )

    # Cria um cursor para executar comandos SQL
    cursor = conn.cursor()
    
    # Define a consulta SQL para obter dados dos clientes, compras e produtos
    query = sql_query
    
    # Executa a consulta SQL
    #cursor.execute(query)
    cursor.execute(query, categoria)

    # Obtém todos os resultados da consulta
    rows = cursor.fetchall()
    
    # Inicializa uma lista para armazenar os insights
    insights = []

    # Criação do template de prompt para o chatbot 
    prompt = ChatPromptTemplate.from_messages(
        [
            ("system", "Você é um cientista de dados especializado. Analise os dados e forneça feedback em português do Brasil sobre previsão de demanda e otimização do estoque de produtos sazonais."),
            ("user", "question: {question}")
        ]
    )

    # Definição da cadeia de execução: prompt -&gt; LLM -&gt; output_parser
    chain = prompt | llm | output_parser

    # Itera sobre as linhas de resultados
    for row in rows:
        
        # Desempacota os valores de cada linha
        id_produto, nome_produto, nome_categoria, nome_fornecedor, total_vendido, quantidade_em_estoque, temporada, quantidade_forecast, quantidade_reabastecida = row
        
        # Cria o prompt para o LLM com base nos dados do cliente
        consulta = f"ID_Produto {id_produto} Nome_Produto {nome_produto} Nome_Categoria {nome_categoria} Nome_Fornecedor {nome_fornecedor} Total_Vendido ${total_vendido:.2f} \
                                quantidade_em_estoque {quantidade_em_estoque:.2f} temporada {temporada} quantidade_forecast {quantidade_forecast} quantidade_reabastecida {quantidade_reabastecida}."
        
        # Gera o texto de insight usando o LLM
        response = chain.invoke({'question': consulta})
        
        # Adiciona o texto gerado à lista de insights
        insights.append(response)
    
    # Fecha a conexão com o banco de dados
    conn.close()

    # Salva os insights em um arquivo CSV
    with open('projetoVarejo-analise.csv', mode='w', newline='', encoding='utf-8') as file:
        writer = csv.writer(file)
        writer.writerow(["Insight"])
        for insight in insights:
            writer.writerow([insight])

    # Retorna a lista de insights
    return insights</code></pre>
</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python"># Gera insights chamando a função definida
insights = fn_gera_insights()</code></pre>
</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python"># Imprime cada insight gerado
for insight in insights:
    print(insight)</code></pre>
</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python"># Define a consulta SQL para obter dados dos clientes, compras e produtos
# Lista de categorias
categoria = ['Eletrônicos', 'Roupas']

# Criar placeholders dinâmicos para a lista
placeholders = ', '.join(['%s'] * len(categoria))

print(placeholders)</code></pre>
</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python"># Projeto 7 - IA Para Previsão de Demanda e Otimização do Estoque de Produtos Sazonais
# Python - Pipeline de Extração de Insights com LLM

# Imports
import csv
import psycopg2
import os
from dotenv import load_dotenv
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
#from langchain_community.llms.ollama import Ollama  # Antigo
from langchain_ollama import OllamaLLM
from concurrent.futures import ThreadPoolExecutor

# Carregar variáveis de ambiente do arquivo .env
load_dotenv('config-postgresql.env',override=True)

# Instanciação do LLM Llama3 através do Ollama
#llm = Ollama(model = "llama3") # Antigo
llm = OllamaLLM(model="llama3")

# Criação do parser para a saída do modelo de linguagem
output_parser = StrOutputParser()

# Define a consulta SQL para obter dados dos clientes, compras e produtos
# Lista de categorias
categoria = ['Eletrônicos', 'Roupas']

# Criar placeholders dinâmicos para a lista
placeholders = ', '.join(['%s'] * len(categoria))

# Query com placeholders
sql_query = f"""
            SELECT
                p.id_produto AS id_produto,
                p.nome_produto AS nome_produto,
                c.nome_categoria AS nome_categoria,
                f.nome_fornecedor AS nome_fornecedor,
                COALESCE(SUM(v.quantidade_vendida), 0) AS total_vendido,
                COALESCE(e.quantidade_em_estoque, 0) AS quantidade_em_estoque,
                COALESCE(s.nome_temporada, 'Nenhuma') AS temporada,
                COALESCE(fore.quantidade_forecast, 0) AS quantidade_forecast,
                COALESCE(re.quantidade, 0) AS quantidade_reabastecida
            FROM
                projetoVarejo.produtos p
            LEFT JOIN
                projetoVarejo.categorias c ON p.id_categoria = c.id_categoria
            LEFT JOIN
                projetoVarejo.fornecedores f ON p.id_fornecedor = f.id_fornecedor
            LEFT JOIN
                projetoVarejo.vendas v ON p.id_produto = v.id_produto
            LEFT JOIN
                projetoVarejo.estoque e ON p.id_produto = e.id_produto
            LEFT JOIN
                projetoVarejo.sazonalidade s ON p.id_produto = s.id_produto
            LEFT JOIN
                projetoVarejo.forecast fore ON p.id_produto = fore.id_produto
            LEFT JOIN
                projetoVarejo.reabastecimento re ON p.id_produto = re.id_produto
            WHERE
                c.nome_categoria IN ({placeholders})
            GROUP BY
                p.id_produto, p.nome_produto, c.nome_categoria, f.nome_fornecedor,
                e.quantidade_em_estoque, e.data_ultimo_reabastecimento,
                s.nome_temporada, s.data_inicio, s.data_fim,
                fore.quantidade_forecast, re.quantidade, re.data_reabastecimento
            ORDER BY
                p.id_produto;
        """

# Instanciação do LLM
llm = OllamaLLM(model="llama3")
output_parser = StrOutputParser()

# Template otimizado do prompt
prompt = ChatPromptTemplate.from_messages(
    [
        ("system", "Você é um cientista de dados especializado. Analise os dados e forneça feedback em português do Brasil sobre previsão de demanda e otimização do estoque de produtos sazonais."),
        ("user", "Analise o seguinte produto e forneça insights: {question}")
    ]  
)

chain = prompt | llm | output_parser

def process_row(row):
    """Gera insights para um único registro."""
    id_produto, nome_produto, nome_categoria, nome_fornecedor, total_vendido, estoque, temporada, forecast, reabastecida = row

    consulta = (
        f"Produto: {nome_produto} ({id_produto}), Categoria: {nome_categoria}, "
        f"Fornecedor: {nome_fornecedor}, Vendidos: {total_vendido}, Estoque: {estoque}, "
        f"Temporada: {temporada}, Previsão: {forecast}, Reabastecido: {reabastecida}."
    )

    try:
        return chain.invoke({'question': consulta})
    except Exception as e:
        return f"Erro no produto {id_produto}: {str(e)}"

def fn_gera_insights():
    """Extrai dados do PostgreSQL e gera insights de forma eficiente."""
    try:
        #conn = psycopg2.connect(**DB_CONFIG)
        # Conecta ao banco de dados PostgreSQL com as credenciais fornecidas
        conn = psycopg2.connect(
        dbname=os.getenv("DB_NAME"),
        user=os.getenv("DB_USER"),
        password=os.getenv("DB_PASSWORD"),
        host=os.getenv("DB_HOST"),
        port=os.getenv("DB_PORT")
    )
        cursor = conn.cursor()

        query = sql_query

        # Criar cursor e executar a query com os parâmetros corretos
        cursor.execute(sql_query, categoria)  # Passando os valores como lista
        
        batch_size = 100  # Lote otimizado para reduzir chamadas excessivas ao banco
        insights = []

        with open('projetoVarejo-analise.csv', mode='w', newline='', encoding='utf-8') as file:
            writer = csv.writer(file)
            writer.writerow(["Insight"])  # Cabeçalho

            while True:
                rows = cursor.fetchmany(batch_size)
                if not rows:
                    break

                # Processamento paralelo com menos threads para reduzir carga na CPU
                #with ThreadPoolExecutor(max_workers=3) as executor:
                with ThreadPoolExecutor(max_workers=2) as executor:                    
                    results = list(executor.map(process_row, rows))

                for insight in results:
                    writer.writerow([insight])
                    insights.append(insight)

        cursor.close()
        conn.close()
        return insights

    except psycopg2.Error as e:
        print(f"Erro ao conectar ao banco: {str(e)}")
        return []

# Executa o pipeline otimizado
insights = fn_gera_insights()

# Imprime cada insight gerado
for insight in insights:
    print(insight)</code></pre>
</div>
<div aria-label="Code Output" class="output" role="region">Análise do produto Smartphone (1) durante a temporada de Dia das Mães!

**Insights**

* **Venda**: O produto vendeu apenas 3 unidades, o que é um número bem abaixo da previsão de 50.
* **Estoque**: Estávamos com um estoque inicial de 50 unidades e não houve reabastecimento durante essa temporada. Isso significa que ainda temos um estoque considerável do produto.
* **Previsão**: A previsão de vendas foi bem alta (50), o que sugere que havia uma boa demanda por esse produto durante a temporada.

**Feedback**

Em primeiro lugar, é importante notar que o produto não vendeu tão bem quanto se esperava. Isso pode ser um sinal de que o preço do produto é alto demais ou que a promoção feita não foi eficaz. Além disso, a falta de reabastecimento durante a temporada pode ter contribuído para a baixa demanda.

No entanto, é importante aproveitar o estoque atual e revisar as estratégias de marketing e promoção para aumentar as vendas. Aqui estão algumas sugestões:

1. **Reavaliação do preço**: É necessário reavaliar o preço do produto para que seja mais competitivo em relação a outros modelos semelhantes.
2. **Reinicialização da promoção**: Reinitiar a promoção e ajustá-la de acordo com as necessidades do mercado e do público-alvo.
3. **Aumento da visibilidade**: Aumentar a visibilidade do produto nos canais de vendas, como lojas físicas e plataformas online, para que mais pessoas o conheçam e o comprem.
4. **Análise de dados**: Realizar uma análise mais profunda dos dados de vendas e comportamento do cliente para identificar oportunidades de melhoria.

**Recomendações**

Em resumo, recomendo:

1. Reavaliar o preço do produto e ajustá-lo de acordo com as necessidades do mercado.
2. Reinitiar a promoção e ajustá-la de acordo com as necessidades do mercado e do público-alvo.
3. Aumentar a visibilidade do produto nos canais de vendas.
4. Realizar uma análise mais profunda dos dados de vendas e comportamento do cliente para identificar oportunidades de melhoria.

Espero que essas sugestões ajudem a otimizar o estoque do Smartphone (1) e aumentar as vendas durante futuras temporadas!
Aqui vai um feedback como cientista de dados:

**Análise da Situação**

O produto Laptop (2) pertencente à categoria Eletrônicos, fornecido pela Fornecedor A, apresenta uma situação interessante.

**Demandas Passadas**

Há 3 unidades vendidas, o que indica uma demanda razoável para esse produto. No entanto, é importante notar que não há temporada específica associada a essa venda, o que pode indicar que a demanda está mais relacionada ao volume de vendas em geral do que à sazonalidade.

**Estoque e Reabastecimento**

O estoque atual é de 30 unidades, enquanto a previsão de demanda para os próximos períodos é de 30 unidades. Isso significa que o estoque está mais ou menos equilibrado com a previsão de demanda.

**Feedback e Sugestões**

Considerando a situação atual, não há grandes preocupações com o estoque do produto Laptop (2). No entanto, como um cientista de dados, gostaria de sugerir algumas coisas:

1. **Monitorize a Demanda**: Embora a demanda seja razoável, é importante monitorar atentamente as vendas para identificar possíveis padrões ou variações na demanda.
2. **Análise da Sazonalidade**: Embora não haja temporada específica associada às vendas, é sempre uma boa prática realizar um estudo de sazonalidade para entender melhor a demanda do produto ao longo do tempo. Isso pode ajudar a identificar oportunidades de otimização do estoque.
3. **Otimização do Estoqui**: Com o estoque atualmente equilibrado com a previsão de demanda, não há necessidade de reabastecer em massa. No entanto, é sempre uma boa prática realizar um estudo de otimização do estoque para garantir que o nível de estoque esteja adequado à demanda.

Em resumo, a situação atual do produto Laptop (2) é estável e equilibrada. É importante monitorar atentamente as vendas e considerar a sazonalidade na tomada de decisões sobre estoque e reabastecimento.
Análise realizada!

Observando os dados fornecidos, posso destacar alguns pontos importantes:

1. **Venda atual:** Foram vendidos apenas 3 TVs 55" no momento, o que representa uma baixa demanda.
2. **Estoque atual:** O estoque de TV 55" é de 20 unidades, o que significa que há um excesso de produtos não vendidos.
3. **Previsão:** A previsão de demanda para este produto é de 20 unidades, o que sugere uma possível aumento da demanda em breve.
4. **Reabastecimento:** O estoque foi reabastecido com 20 novas unidades, o que pode ser uma oportunidade para ajustar a estratégia de estoque.

Insights:

* **Ajuste do estoque:** Considero necessário ajustar o estoque de TV 55" para evitar perdas financeiras e minimizar os riscos. Com um estoque atual de 20 unidades e uma previsão de demanda de 20, acho que é possível manter apenas 10-15 unidades em estoque, mantendo assim um nível mais razoável.
* **Melhorias na gestão:** A partir daqui, sugiro que sejam implementadas melhorias na gestão do estoque, como monitoramento da demanda e ajustes periódicos no estoque para garantir que a oferta esteja alinhada com a demanda.
* **Análise de tendências:** É importante realizar uma análise mais aprofundada sobre as tendências de vendas e previsão de demanda para o futuro, especialmente considerando a temporada (ou falta de temporada) do produto.

Recomendação final:

Ajuste o estoque de TV 55" para manter apenas 10-15 unidades em estoque, mantendo um nível mais razoável. Além disso, implemente melhorias na gestão do estoque e realize análise mais aprofundada sobre as tendências de vendas e previsão de demanda para o futuro.
Análise realizada!

Vendo os dados, posso dizer que o produto "Caixa de Som Bluetooth" da categoria Eletrônicos, fornecido pelo Fornecedor C, apresenta uma situação interessante.

**Vendidos:** 5 unidades vendidas até agora não é um número alto, mas é suficiente para entender a tendência da demanda do produto. Embora a quantidade seja baixa, é importante considerar que o estoque inicial é relativamente grande (100 unidades).

**Previsão:** A previsão de demanda está estabelecida em 100 unidades, o que significa que o estoque atual não está completamente vazio. No entanto, essa previsão pode ser uma estimativa conservadora, pois a temporada não foi especificada.

**Reabastecido:** O estoque foi reabastecido para 100 unidades, o que é um sinal positivo de que o fornecedor C tem capacidade para atender à demanda em caso de aumento repentino.

**Otimização do estoque:**

* Considere reduzir o estoque inicial para um nível mais conservador (por exemplo, 50-60 unidades), pois a previsão de demanda é relativamente alta e não há informações sobre uma temporada específica. Isso ajudaria a evitar perdas caso haja uma redução brusca na demanda.
* Implemente um sistema de gerenciamento de estoque mais eficaz para monitorar as vendas e ajustar o estoque em tempo real, evitando sobre-estoques ou sub-estoques.
* Fique atento à mudanças nas tendências de venda e reajuste a previsão de demanda com base nos dados históricos.

**Conclusão:** Embora os dados não apoiem uma temporada específica, é importante monitorar as vendas e ajustar o estoque em função das necessidades do mercado. Uma abordagem mais conservadora em termos de estoque inicial pode ser benéfica para evitar perdas.
Análise feita!

**Produto:** Tablet (5)
**Categoria:** Eletrônicos
**Fornecedor:** Fornecedor D
**Vendidos:** 3
**Estoque:** 40
**Temporada:** Nenhuma
**Previsão:** 40
**Reabastecido:** 40

**Insights:**

1. **Venda fraca**: Apesar de terem sido vendidos apenas 3 unidades, é importante considerar que o estoque inicial era de 40 unidades, o que significa que a demanda real foi muito baixa em relação ao estoque disponível.
2. **Previsão conservadora**: A previsão de venda para o futuro é de 40 unidades, o mesmo valor do estoque atual. Isso pode ser considerado uma previsão conservadora, pois se não houver um aumento significativo na demanda, a empresa poderá ter excesso de estoque.
3. **Reabastecimento**: O reabastecimento do estoque para 40 unidades é uma boa decisão, pois garantirá que o estoque esteja sempre abastado e pronto para atender à demanda.

**Recursos recomendados:**

1. **Análise de dados históricos**: Analisar as vendas do produto em diferentes períodos (por exemplo, semanas, meses, trimestres) pode ajudar a identificar padrões e tendências na demanda.
2. **Modelagem de demanda**: Utilizar modelos de aprendizado automático ou técnicas de previsão de demanda para melhorar as previsões e otimizar os estoques.
3. **Análise de concorrência**: Analisar a concorrência no mercado e suas estratégias de marketing e vendas pode ajudar a identificar oportunidades de negócios e ajustes na estratégia da empresa.

**Conclusão:**

A análise dos dados indica que o estoque do produto Tablet (5) está atualmente excessivo, embora a previsão de venda seja conservadora. É recomendável realizar uma análise mais detalhada dos dados históricos e utilizar técnicas de modelagem de demanda para melhorar as previsões e otimizar os estoques. Além disso, é importante analisar a concorrência no mercado para identificar oportunidades de negócios e ajustes na estratégia da empresa.
Analise realizada!

**Insights sobre a demanda do produto Camisa Polo (11)**

Vendidos: 5 - Um número relativamente baixo de vendas para um produto com estoque disponível.

Estoque: 70 - Um estoque razoável, mas que pode não estar completamente utilizado.

Previsão: 70 - A previsão é conservadora e igual ao estoque atual. Isso sugere que a demanda futura será similar à demanda passada.

**Análise da temporada**

A falta de definição sobre a temporada do produto faz com que seja difícil estimar a demanda futura. No entanto, como o estoque não está completamente vendido e a previsão é conservadora, é provável que a demanda se mantenha constante ou aumente levemente.

**Recomendações para otimização do estoque**

1. **Reavaliar a previsão**: Com base nos dados anteriores, pode ser necessário reavaliar a previsão de demanda e considerar fatores como mudanças na temperatura, datas de eventos esportivos ou outras influências que possam afetar a demanda do produto.
2. **Reabastecer o estoque**: Considerando o estoque atual e a previsão conservadora, é recomendável reabastecer o estoque para garantir a disponibilidade do produto e evitar perdas de vendas.
3. **Análise de dados mais detalhada**: Para obter uma visão mais precisa da demanda do produto, é necessário analisar dados mais detalhados sobre as vendas e estoque ao longo dos meses para identificar padrões e tendências.

Em resumo, a análise indica que o estoque do Camisa Polo (11) não está sendo completamente utilizado e que a previsão de demanda pode ser conservadora. É recomendável reavaliar a previsão e reabastecer o estoque para garantir a disponibilidade do produto.
Análise realizada!

**Resumo**

O produto Calça Jeans (12) da categoria Roupas, fornecido pelo Fornecedor B, apresenta uma situação interessante.

**Análise das Vendas**

Até o momento, apenas 2 unidades do produto foram vendidas. Isso sugere que a demanda é baixa, o que pode ser um sinal de que o produto não está muito popular ou não está no período de maior procura.

**Análise do Estoquiagem**

O estoque atual é de 60 unidades, o que é uma quantia razoável. No entanto, a previsão de demanda é de 60 unidades, o que significa que o estoque não está sendo consumido rapidamente e não há necessidade de reabastecimento imediato.

**Insights**

Considerando as vendas e o estoquiagem, pode-se concluir que:

1. A demanda por Calça Jeans (12) é baixa.
2. O estoque atual é razoável e não há necessidade de reabestecimento imediato.
3. É importante monitorar a evolução da demanda e ajustar o estoquiagem de acordo com as vendas futuras.

**Recomendações**

Para otimizar o estoque e prever a demanda, sugiero:

1. Monitorar atentamente as vendas nos próximos períodos para identificar padrões ou mudanças na demanda.
2. Reavaliar a previsão de demanda após um período de tempo razoável (ex.: 3-6 meses) e ajustá-la se necessário.
3. Considerar reabestecimento apenas quando a previsão de demanda for superior ao estoque atual.

**Conclusão**

Em resumo, o produto Calça Jeans (12) apresenta uma situação estável em termos de estoquiagem e demanda. É importante monitorar a evolução da demanda e ajustar o estoquiagem para garantir que as necessidades do cliente sejam atendidas e minimizar perdas por excesso de estoque.
Análise do produto Tênis Esportivo (13)!

**Resumo**

* O estoque atual é de 90 unidades.
* A previsão de demanda é de 90 unidades.
* A venda realizada até agora é de 2 unidades.

**Insights**

* Como o estoque atual é maior que a previsão de demanda, não há necessidade de reabastecimento imediato.
* No entanto, é importante monitorar a evolução da temporada e do comportamento do mercado para ajustar a estratégia de estoque de acordo com as necessidades futuras.
* Como o produto é sazonal (esportivo), é provável que haja uma demanda maior durante as épocas de jogos esportivos ou eventos importantes. Portanto, é recomendado monitorar a temporada e ajustar o estoque para atender à demanda Crescente em momentos críticos.
* Além disso, é importante avaliar se há variações sazonais na demanda do produto e ajustar o estoque de acordo com essas variabilidades.

**Recomendação**

* Monitorar a temporada e as tendências de venda para ajustar o estoque de forma adequada.
* Considerar uma revisão da previsão de demanda para contemplar possíveis variações sazonais.
* Manter um estoque razoável, mas não excessivo, para atender à demanda Crescente durante os períodos de jogos esportivos ou eventos importantes.

Espero que essas informações tenham sido úteis!
Análise do produto Jaqueta de Couro (14):

**Observações Gerais**

* O estoque atual é alto, com 80 unidades.
* A previsão de demanda é igual ao estoque atual, com 80 unidades previstas para venda.
* Não há temporada especificada para este produto, o que pode sugerir que ele não tem uma época mais movimentada do ano.

**Insights**

* Com um estoque alto e uma previsão de demanda igual ao estoque, é provável que tenhamos excesso de estoque. Isso pode levar a problemas de armazenamento e manutenção do produto.
* A falta de temporada específica para este produto sugere que o consumo é mais constante ao longo do ano, mas isso não impede que haja variações sazonais em sua demanda.
* É recomendável reavaliar a estratégia de estoque e considerar ajustes para minimizar os custos de armazenamento e manutenção.

**Recomendações**

1. **Análise da Curva de Demanda**: Analisar as vendas históricas do produto e identificar eventuais padrões de comportamento de consumo, seja por temporada ou por período de semana.
2. **Ajuste do Estoque**: Considerar ajustes no estoque para evitar excessos e garantir que o estoque esteja em sincronia com a demanda prevista.
3. **Reabastecimento**: Reavaliar a política de reabastecimento e considerar reabastecer apenas o necessário para atender à demanda prevista, evitando excessos de estoque.
4. **Monitoramento**: Monitore as vendas e os estoques regularmente para ajustes rápidos em caso de mudanças na demanda.

**Conclusão**

Em resumo, o produto Jaqueta de Couro (14) apresenta um estoque alto e uma previsão de demanda igual ao estoque. É importante reavaliar a estratégia de estoque e considerar ajustes para minimizar os custos de armazenamento e manutenção. Além disso, é fundamental monitorar as vendas e os estoques regularmente para ajustes rápidos em caso de mudanças na demanda.
Análise do produto Meias 3 pares (15) para a temporada de Dia dos Pais:

**Previsão de demanda:** A previsão de demanda é igual à quantidade vendida no período passado, que foi de 9 unidades. No entanto, é importante considerar que o Dia dos Pai é uma data específica com um padrão de consumo mais alto. Considerando isso, sugiro uma reajustada previsão de demanda de cerca de 25-30 unidades, levando em conta a curva de demanda histórica para essa data.

**Análise do estoque:** O estoque atual é de 130 unidades, o que parece adequado para atender à demanda prevista. No entanto, é fundamental monitorar a movimentação do estoque e ajustar as reabastecimentos com base nas vendas efetivas.

**Otimização do estoque:** Para otimizar o estoque de Meias 3 pares (15) para a temporada de Dia dos Pais, sugiro:

1. Reabastecer o estoque com cerca de 25-30 unidades, considerando a previsão de demanda ajustada.
2. Monitorar atentamente as vendas e ajustar os reabastecimentos diariamente, caso necessário.
3. Considerar a possibilidade de realizar promoções ou ofertas especiais para atrair mais clientes e aumentar as vendas.

**Conclusão:** Em geral, o estoque atual parece adequado para atender à demanda prevista para o Dia dos Pai. No entanto, é fundamental monitorar a movimentação do estoque e ajustar os reabastecimentos com base nas vendas efetivas. Além disso, sugiro uma reajustada previsão de demanda e considerar opções de promoções ou ofertas especiais para aumentar as vendas.
</div>
</div>
<div class="cell">
<div aria-label="Markdown Cell" class="markdown" role="region">
<div style="background-color:#F3F2EE">
<p><font color="#CC403E" size="4"><strong>Script 05-Run-Pipeline.py</strong></font></p>
<font color="#66666" size="2">
<p><strong>Python - Executa o Pipeline</strong></p>
</font></div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python"># Imports
import subprocess</code></pre>
</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python"># Versões dos pacotes usados neste jupyter notebook
%reload_ext watermark
%watermark -a "Roberto-SSoares-LfLngLrnng"</code></pre>
</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python"># Projeto 7 - IA Para Previsão de Demanda e Otimização do Estoque de Produtos Sazonais
# Função para executar outros scripts Python
def fn_run_pipeline(script_name):
    try:
        result = subprocess.run(['python', script_name], check=True, capture_output=True, text=True)
        print(f"\nScript {script_name} executado com sucesso.")
        print("\nSaída:\n", result.stdout)
    except subprocess.CalledProcessError as e:
        print(f"\nErro ao executar o script {script_name}.")
        print("\nErro:\n", e.stderr)

# Lista de scripts
scripts = [
    'ProjetoVarejo-02-CriaTabelas.py',
    'ProjetoVarejo-03-CarregaDados.py',
    'ProjetoVarejo-04-LLM.py'
]</code></pre>
</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python"># Executa os scripts em um loop
for script in scripts:
    fn_run_pipeline(script)

print(f"\nPipeline executado com sucesso.\n")</code></pre>
</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python">%reload_ext watermark
%watermark -a "Roberto-SSoares-LfLngLrnng"</code></pre>
</div>
<div aria-label="Code Output" class="output" role="region">Author: Roberto-SSoares-LfLngLrnng

</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python">%watermark -v -m</code></pre>
</div>
<div aria-label="Code Output" class="output" role="region">Python implementation: CPython
Python version       : 3.10.14
IPython version      : 8.27.0

Compiler    : MSC v.1916 64 bit (AMD64)
OS          : Windows
Release     : 10
Machine     : AMD64
Processor   : Intel64 Family 6 Model 158 Stepping 9, GenuineIntel
CPU cores   : 4
Architecture: 64bit

</div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python">%watermark --iversions</code></pre>
</div>
<div aria-label="Code Output" class="output" role="region">csv             : 1.0
psycopg2        : 2.9.9
langchain_ollama: 0.2.3
langchain_core  : 0.3.34

</div>
</div>
<div class="cell">
<div aria-label="Markdown Cell" class="markdown" role="region">
<div style="background-color:#F3F2EE">
<p><font color="#CC403E" size="5"><strong>Fim</strong></font></p>
<font color="#66666" size="3">
</font></div>
</div>
<div class="cell">
<div aria-label="Code Cell" class="code_cell" role="region">
<pre><code class="language-python"></code></pre>
</div>
</div>
<div class="footer">
<p>RobertoSSoares-LfLngLrnng</p>
<p id="datetime"></p>
<script>
                document.getElementById("datetime").innerText = new Date().toLocaleString();
            </script>
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
</div></div></div></div></div></div></div></div></div></body>
</html>